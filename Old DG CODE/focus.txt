IDENTIFICATION DIVISION
PROGRAM-ID. FOCUS.
AUTHOR. JAY ANDERSON.
ENVIRONMENT DIVISION.
CONFIGURATION SECTION.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
  	SELECT ANINFOSFILE
  		ASSIGN INDEX TO 'ANINFOSFILE'
  		ASSIGN DATA TO 'ANINFOSFILE.DB'
  		ORGANIZATION IS INDEXED
  		ACCESS MODE IS DYNAMIC
  		RECORD KEYS ARE SELECT-ANINFOSFILE
  				ANINFOSFILE-KEY
  		FILE STATUS IS FILE-STATUS
  		INFOS STATUS IS INFOS-STATUS.

DATA DIVISION.
FILE SECTION.
FD  ANINFOSFILE
      FEEDBACK IS ANINFOSFILEFB.
01  ANINFOSFILEREC 	PIC X(80).
WORKING-STORAGE SECTION.
01  ELINE-1.
	05  ERR-FILE-NAME			PIC X(10) VALUE SPACES.
	05  ERR-DUMMY				PIC X VALUE SPACES.
	05  FILE-STATUS				PIC X(2).
		88 I-O-OK				  VALUE "00".
		88 DUPLICATE-ADDED			  VALUE "02".
		88 DUPLICATE-READ			  VALUE "02".
		88 AT-END				  VALUE "10".
		88 DUPLICATE-KEY			  VALUE "22".
		88 RECORD-NOT-FOUND			  VALUE "23".
		88 KEY-TOO-LARGE			  VALUE "24".
		88 HARDWARE-ERROR			  VALUE "30".
		88 OPEN-ERROR				  VALUE "91".
		88 MODE-ERROR				  VALUE "92".
		88 RECORD-LOCKED			  VALUE "94".
	05  FILLER				PIC X VALUE SPACE.
   	05  INFOS-STATUS.
		10  ISTATDIGIT OCCURS 11 INDEXED BY DIGITNDX
						PIC 99 COMP.
	05  FILLER				PIC X VALUE SPACE.
	05  ERR-USER-MSG			PIC X(74).
01  ELINE-2.
	05  ERR-MESS				PIC X(80).
01  ERR-KEYS.
	05  ERR-KLINE OCCURS 6 INDEXED BY ERRNDX.
		10  ERR-KEY-LN			PIC S99 COMP.
		10  ERR-KEY			PIC X(79).
01  HEX255					PIC X(255).
01  HEXLN					PIC 9(4) COMP.
01  ERRWRD					PIC 9(9) COMP.
01  ASCIIZERO					PIC S99 COMP VALUE 48.
01  RA-DIX					PIC 99 COMP VALUE 8.
01  WHO-PID		        PIC 999.
01  WHO-CON.
	05 WHO-CON1		PIC X.
	    88  RUNNING-CONSOLE	VALUE 'C' 'V'.
	    88  RUNNING-BATCH  	VALUE 'S' 'B'.
	05 FILLER PIC X(31) VALUE SPACES.
01  WHO-USER                    PIC X(32) VALUE SPACES.
*******
01  ANINFOSFILEFB				PIC X(4).
01  SELECT-ANINFOSFILE			PIC X(5) VALUE 'INFOS'.
01  ANINFOSFILEREC-WS.
	05  ANINFOSFILE-KEY.
		10  ANINFOSFILE-NUMBER	PIC 9(6).
	05  ANINFOSFILE-DATA.
		10  ANINFOSFILE-DATA    	PIC X(74).

SCREEN SECTION.
01  SCR-ERR-LINE.
	05  SCR-BLANK-23 LINE 23 BLANK LINE.
	05  LINE 23 COL 01  PIC X(80) FROM ELINE-1.
	05  SCR-ERR-MSG.
		10  LINE 24 BLANK LINE PIC X(50) FROM ERR-MESS.
		10  LINE 24 COL 51 'ENTER / TO CONTINUE'.
		10  LINE 24 COL 79 PIC X TO ERR-DUMMY.
PROCEDURE DIVISION.
DECLARATIVES.
AN-INFOSFILE SECTION.
	USE AFTER ERROR PROCEDURE ON ANINFOSFILE.
	MOVE "ANINFOSFILE" TO ERR-FILE-NAME.
END DECLARATIVES.
MAIN  SECTION.
0010-CONTROL.
	CALL "WHO" USING WHO-PID WHO-CON WHO-USER.
	OPEN I-O ANINFOSFILE.
	IF I-O-OK
	     NEXT SENTENCE
	ELSE MOVE 'OPEN' TO ERR-USER-MSG
	     PERFORM 9999-ERROR.
	READ ANINFOSFILE SUPPRESS DATA KEY IS SELECT-ANINFOSFILE.
	IF I-O-OK
	     NEXT SENTENCE
	ELSE MOVE 'SELECTOR MISSING' TO ERR-USER-MSG
	     PERFORM 9999-ERROR.
	CLOSE ANINFOSFILE.
	STOP RUN.
0010-EXIT. EXIT.

9999-ERROR.
*****
* CALL PPKEY WILL ONLY WORK IF THERE HAS BEEN NO COBOL I-O
* AFTER AN INFOS CALL
*****
	MOVE ZERO TO
		ERR-KEY-LN (1) ERR-KEY-LN (2) ERR-KEY-LN (3)
	        ERR-KEY-LN (4) ERR-KEY-LN (5) ERR-KEY-LN (6).
	CALL 'PPKEY' USING ERR-KEYS.
	PERFORM 9999-10-OCTAL-TO-DECIMAL.
	IF ERRWRD = ZERO
		MOVE 'NO ERROR OCCURRED ....' TO ERR-MESS
	ELSE CALL 'ERMSG' USING ERRWRD ERR-MESS ERRWRD.
	IF RUNNING-CONSOLE
		MOVE ' ' TO ERR-DUMMY
		PERFORM 9999-05-ACCEPTER UNTIL ERR-DUMMY = '/'
	ELSE DISPLAY ELINE-1
	     DISPLAY ELINE-2.
	MOVE ELINE-1 TO HEX255.
	MOVE 80 TO HEXLN.
	CALL 'HEXTODISK' USING HEXLN HEX255.
	MOVE ELINE-2 TO HEX255.
	MOVE 80 TO HEXLN.
	CALL 'HEXTODISK' USING HEXLN HEX255.
	PERFORM 9999-30-HEXKEYS VARYING ERRNDX FROM 1 BY 1
 			UNTIL ERRNDX > 6.
	STOP RUN 'ABORT'.

9999-05-ACCEPTER.
	DISPLAY SCR-ERR-LINE.
	ACCEPT  SCR-ERR-LINE.

9999-10-OCTAL-TO-DECIMAL.
	MOVE 0 TO ERRWRD.
	PERFORM 9999-20-DIGIT VARYING DIGITNDX FROM 1 BY 1 UNTIL
	  DIGITNDX > 11.

9999-20-DIGIT.
	COMPUTE ERRWRD = (RA-DIX * ERRWRD) +
		(ISTATDIGIT (DIGITNDX) - ASCIIZERO).

9999-30-HEXKEYS.
	IF ERR-KEY-LN (ERRNDX) = ZERO
		SET ERRNDX TO 6
	ELSE MOVE ERR-KEY-LN (ERRNDX) TO HEXLN
	     MOVE ERR-KEY (ERRNDX) TO HEX255
	     CALL 'HEXTODISK' USING HEXLN HEX255.

